source("R/header.R")

phy <- read.nexus(file = str_c(path_proc_data, "/angio_phy_modified.nex"))
stomata <- read_csv(str_c(path_proc_data, "/stomata_filtered.csv"))

##### Raunikaer life form and Ellenberg light indicator values versus sr_even -----

# Phylogenetic ANOVA (takes several minutes to run)
# fitSR_pp <- phylopars.lm(sr_even ~ ellenberg_light * lifeform,
#                          trait_data = stomata[, c("species", "sr_even", "ellenberg_light", "lifeform")],
#                          tree = phy, model = "OU", REML = F)
# write_rds(fitSR_pp, path = str_c(path_objects, "/fitSR_pp.rds"))
fitSR_pp <- read_rds(str_c(path_objects, "/fitSR_pp.rds"))
anova(fitSR_pp)

# Parametric bootstrap CIs of full model for plotting
# NOTE - this could be done with Rphylopars, which might be better because parameter estimates are slightly different for some reason
# set.seed(36502)
# fitSR_pl <- phylolm(sr_even ~ -1 + lifeform + ellenberg_light:lifeform, 
#                     model = "OUrandomRoot", data = stomata, phy = phy, boot = 1e3)
# write_rds(fitSR_pl, path = str_c(path_objects, "/fitSR_pl.rds"))
fitSR_pl <- read_rds(str_c(path_objects, "/fitSR_pl.rds"))

# Figure

pdf(str_c(path_figures, "/figure_SRmultReg.pdf"), 4, 7)
par(mfrow = c(5, 1), mar = rep(0, 4), cex.lab = 1, oma = c(5, 7, 1, 1))

lf <- c("chamaephyte", "geophyte", "hemicryptophyte", "phanerophyte", "therophyte")
names(lf) = c("Ch", "Gn", "hc", "Ph", "Th")
lf <- lf[names(sort(tapply(stomata$sr_propAd, stomata$lifeform, mean)))]

for (i in 5:1) {
  
  plot(0, 0, type = "n", xlim = c(0, 9), ylim = c(-0.05, 1.05), xlab = "", 
       ylab = "", axes = F, frame.plot = F)
  if (i %in% seq(1, 5, 2)) {
    axis(2, at = seq(0, 1, 0.5), lwd = 0, lwd.ticks = 1, las = 1)
  }
  
  # polygon of confidence intervals
  x <- seq(min(stomata$ellenberg_light[stomata$lifeform == names(lf)[i]]),
           max(stomata$ellenberg_light[stomata$lifeform == names(lf)[i]]), 
           length.out = 1e3)
  bs <- sapply(x, function(X) {
    fitSR_pl$bootstrap[, sprintf('lifeform%s', names(lf)[i])] + 
      fitSR_pl$bootstrap[, sprintf('lifeform%s:ellenberg_light', names(lf)[i])] * X
  } )
  ci <- apply(bs, 2, quantile, probs = c(0.025, 0.5, 0.975))
  polygon(c(x, rev(x)), c(ci[1, ], rev(ci[3, ])), col = "grey", border = NA)
  points(x, ci[2, ], lwd = 2, type = "l") # median
  points(x, ci[1, ], lwd = 2, lty = 2, type = "l") # lower 95%
  points(x, ci[3, ], lwd = 2, lty = 2, type = "l") # upper 95%
  
  # plot points
  with(subset(stomata, stomata$lifeform == names(lf)[i]), 
       points(jitter(ellenberg_light), sr_even, pch = 21, bg = rgb(0, 0, 0, 0.1), 
              cex = 2))
  
  # label life forms
  s <- sprintf("%s (%s)", lf[i], table(stomata$lifeform)[names(lf)[i]])
  text(0 + 0.5 * strwidth(s), 1.05, labels = s, pos = 1)
  
}

# frame plot
clip(grconvertX(0, from = "ndc", "user"), grconvertX(1, from = "ndc", "user"),
     grconvertY(0, from = "ndc", "user"), grconvertY(1, from = "ndc", "user"))
abline(h = grconvertY(0:5, "npc", "user"))
lines(rep(grconvertX(0, "npc", "user"), 2), grconvertY(c(0, 5), "npc", "user"))
lines(rep(grconvertX(1, "npc", "user"), 2), grconvertY(c(0, 5), "npc", "user"))

# axis labels
axis(1, at = 0.5:8.5, labels = 1:9, lwd = 0, line = -1)
axis(1, at = c(1.5, 4.5, 7.5), lwd = 0, labels = c("Shade", "Partial Shade", "Sun"),
     line = 0)
mtext(1, text = "Ellenberg light indicator", cex = 1.5, line = 3, outer = T)

mtext(2, text = "Stomatal Ratio",  line = 4.5, outer = T, cex = 1.5)

mtext(2, text = expression(
  SR[even] == plain(min)~group("(", list(SD[ab], SD[ad]), ")") /
    plain(max)~group("(", list(SD[ab], SD[ad]), ")")), outer = T, line = 2.5)

dev.off()
